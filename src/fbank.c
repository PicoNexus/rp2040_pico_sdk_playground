#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include <pthread.h>
#include <signal.h>

#include <complex.h>
#include <math.h>

#include <assert.h>

#include "fbank.h"

#include "arm_math.h"

#define PREEMP_COEFF (0.97f)

#define NUM_FFT (512UL)
#define NUM_FFT_BINS ((NUM_FFT / 2UL) + 1UL)
#define F_EPS (2.220446049250313e-16f)
#define FILTERBANK_LEN (40)

// clang-format off

static const uint8_t FILTERBANK_OFF[NUM_FILT] = 
   { 1,  2,  4,  6,  9,  11,  14,  16,
     19,  23,  26,  30,  34,  39,  43,  49,
     54,  60,  67,  74,  81,  90,  98,  108,
     118,  129,  141,  154,  168,  184,  200,  217};

static const float FILTERBANK_MAT[NUM_FILT][FILTERBANK_LEN] = {
   { 1.00000000e+00,  5.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 5.00000000e-01,  1.00000000e+00,  5.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 5.00000000e-01,  1.00000000e+00,  6.66666667e-01,  3.33333333e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 3.33333333e-01,  6.66666667e-01,  1.00000000e+00,  5.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 5.00000000e-01,  1.00000000e+00,  6.66666667e-01,  3.33333333e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 3.33333333e-01,  6.66666667e-01,  1.00000000e+00,  5.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 5.00000000e-01,  1.00000000e+00,  6.66666667e-01,  3.33333333e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 3.33333333e-01,  6.66666667e-01,  1.00000000e+00,  7.50000000e-01,  5.00000000e-01,  2.50000000e-01,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 2.50000000e-01,  5.00000000e-01,  7.50000000e-01,  1.00000000e+00,  6.66666667e-01,  3.33333333e-01,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 3.33333333e-01,  6.66666667e-01,  1.00000000e+00,  7.50000000e-01,  5.00000000e-01,  2.50000000e-01,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 2.50000000e-01,  5.00000000e-01,  7.50000000e-01,  1.00000000e+00,  7.50000000e-01,  5.00000000e-01,  2.50000000e-01,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 2.50000000e-01,  5.00000000e-01,  7.50000000e-01,  1.00000000e+00,  8.00000000e-01,  6.00000000e-01,  4.00000000e-01,  2.00000000e-01,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 2.00000000e-01,  4.00000000e-01,  6.00000000e-01,  8.00000000e-01,  1.00000000e+00,  7.50000000e-01,  5.00000000e-01,  2.50000000e-01,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 2.50000000e-01,  5.00000000e-01,  7.50000000e-01,  1.00000000e+00,  8.33333333e-01,  6.66666667e-01,  5.00000000e-01,  3.33333333e-01,
     1.66666667e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.66666667e-01,  3.33333333e-01,  5.00000000e-01,  6.66666667e-01,  8.33333333e-01,  1.00000000e+00,  8.00000000e-01,  6.00000000e-01,
     4.00000000e-01,  2.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 2.00000000e-01,  4.00000000e-01,  6.00000000e-01,  8.00000000e-01,  1.00000000e+00,  8.33333333e-01,  6.66666667e-01,  5.00000000e-01,
     3.33333333e-01,  1.66666667e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.66666667e-01,  3.33333333e-01,  5.00000000e-01,  6.66666667e-01,  8.33333333e-01,  1.00000000e+00,  8.57142857e-01,  7.14285714e-01,
     5.71428571e-01,  4.28571429e-01,  2.85714286e-01,  1.42857143e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.42857143e-01,  2.85714286e-01,  4.28571429e-01,  5.71428571e-01,  7.14285714e-01,  8.57142857e-01,  1.00000000e+00,  8.57142857e-01,
     7.14285714e-01,  5.71428571e-01,  4.28571429e-01,  2.85714286e-01,  1.42857143e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.42857143e-01,  2.85714286e-01,  4.28571429e-01,  5.71428571e-01,  7.14285714e-01,  8.57142857e-01,  1.00000000e+00,  8.57142857e-01,
     7.14285714e-01,  5.71428571e-01,  4.28571429e-01,  2.85714286e-01,  1.42857143e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.42857143e-01,  2.85714286e-01,  4.28571429e-01,  5.71428571e-01,  7.14285714e-01,  8.57142857e-01,  1.00000000e+00,  8.88888889e-01,
     7.77777778e-01,  6.66666667e-01,  5.55555556e-01,  4.44444444e-01,  3.33333333e-01,  2.22222222e-01,  1.11111111e-01,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.11111111e-01,  2.22222222e-01,  3.33333333e-01,  4.44444444e-01,  5.55555556e-01,  6.66666667e-01,  7.77777778e-01,  8.88888889e-01,
     1.00000000e+00,  8.75000000e-01,  7.50000000e-01,  6.25000000e-01,  5.00000000e-01,  3.75000000e-01,  2.50000000e-01,  1.25000000e-01,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.25000000e-01,  2.50000000e-01,  3.75000000e-01,  5.00000000e-01,  6.25000000e-01,  7.50000000e-01,  8.75000000e-01,  1.00000000e+00,
     9.00000000e-01,  8.00000000e-01,  7.00000000e-01,  6.00000000e-01,  5.00000000e-01,  4.00000000e-01,  3.00000000e-01,  2.00000000e-01,
     1.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.00000000e-01,  2.00000000e-01,  3.00000000e-01,  4.00000000e-01,  5.00000000e-01,  6.00000000e-01,  7.00000000e-01,  8.00000000e-01,
     9.00000000e-01,  1.00000000e+00,  9.00000000e-01,  8.00000000e-01,  7.00000000e-01,  6.00000000e-01,  5.00000000e-01,  4.00000000e-01,
     3.00000000e-01,  2.00000000e-01,  1.00000000e-01,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 1.00000000e-01,  2.00000000e-01,  3.00000000e-01,  4.00000000e-01,  5.00000000e-01,  6.00000000e-01,  7.00000000e-01,  8.00000000e-01,
     9.00000000e-01,  1.00000000e+00,  9.09090909e-01,  8.18181818e-01,  7.27272727e-01,  6.36363636e-01,  5.45454545e-01,  4.54545455e-01,
     3.63636364e-01,  2.72727273e-01,  1.81818182e-01,  9.09090909e-02,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 9.09090909e-02,  1.81818182e-01,  2.72727273e-01,  3.63636364e-01,  4.54545455e-01,  5.45454545e-01,  6.36363636e-01,  7.27272727e-01,
     8.18181818e-01,  9.09090909e-01,  1.00000000e+00,  9.16666667e-01,  8.33333333e-01,  7.50000000e-01,  6.66666667e-01,  5.83333333e-01,
     5.00000000e-01,  4.16666667e-01,  3.33333333e-01,  2.50000000e-01,  1.66666667e-01,  8.33333333e-02,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 8.33333333e-02,  1.66666667e-01,  2.50000000e-01,  3.33333333e-01,  4.16666667e-01,  5.00000000e-01,  5.83333333e-01,  6.66666667e-01,
     7.50000000e-01,  8.33333333e-01,  9.16666667e-01,  1.00000000e+00,  9.23076923e-01,  8.46153846e-01,  7.69230769e-01,  6.92307692e-01,
     6.15384615e-01,  5.38461538e-01,  4.61538462e-01,  3.84615385e-01,  3.07692308e-01,  2.30769231e-01,  1.53846154e-01,  7.69230769e-02,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 7.69230769e-02,  1.53846154e-01,  2.30769231e-01,  3.07692308e-01,  3.84615385e-01,  4.61538462e-01,  5.38461538e-01,  6.15384615e-01,
     6.92307692e-01,  7.69230769e-01,  8.46153846e-01,  9.23076923e-01,  1.00000000e+00,  9.28571429e-01,  8.57142857e-01,  7.85714286e-01,
     7.14285714e-01,  6.42857143e-01,  5.71428571e-01,  5.00000000e-01,  4.28571429e-01,  3.57142857e-01,  2.85714286e-01,  2.14285714e-01,
     1.42857143e-01,  7.14285714e-02,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 7.14285714e-02,  1.42857143e-01,  2.14285714e-01,  2.85714286e-01,  3.57142857e-01,  4.28571429e-01,  5.00000000e-01,  5.71428571e-01,
     6.42857143e-01,  7.14285714e-01,  7.85714286e-01,  8.57142857e-01,  9.28571429e-01,  1.00000000e+00,  9.37500000e-01,  8.75000000e-01,
     8.12500000e-01,  7.50000000e-01,  6.87500000e-01,  6.25000000e-01,  5.62500000e-01,  5.00000000e-01,  4.37500000e-01,  3.75000000e-01,
     3.12500000e-01,  2.50000000e-01,  1.87500000e-01,  1.25000000e-01,  6.25000000e-02,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 6.25000000e-02,  1.25000000e-01,  1.87500000e-01,  2.50000000e-01,  3.12500000e-01,  3.75000000e-01,  4.37500000e-01,  5.00000000e-01,
     5.62500000e-01,  6.25000000e-01,  6.87500000e-01,  7.50000000e-01,  8.12500000e-01,  8.75000000e-01,  9.37500000e-01,  1.00000000e+00,
     9.37500000e-01,  8.75000000e-01,  8.12500000e-01,  7.50000000e-01,  6.87500000e-01,  6.25000000e-01,  5.62500000e-01,  5.00000000e-01,
     4.37500000e-01,  3.75000000e-01,  3.12500000e-01,  2.50000000e-01,  1.87500000e-01,  1.25000000e-01,  6.25000000e-02,  0.00000000e+00,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 6.25000000e-02,  1.25000000e-01,  1.87500000e-01,  2.50000000e-01,  3.12500000e-01,  3.75000000e-01,  4.37500000e-01,  5.00000000e-01,
     5.62500000e-01,  6.25000000e-01,  6.87500000e-01,  7.50000000e-01,  8.12500000e-01,  8.75000000e-01,  9.37500000e-01,  1.00000000e+00,
     9.41176471e-01,  8.82352941e-01,  8.23529412e-01,  7.64705882e-01,  7.05882353e-01,  6.47058824e-01,  5.88235294e-01,  5.29411765e-01,
     4.70588235e-01,  4.11764706e-01,  3.52941176e-01,  2.94117647e-01,  2.35294118e-01,  1.76470588e-01,  1.17647059e-01,  5.88235294e-02,
     0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 5.88235294e-02,  1.17647059e-01,  1.76470588e-01,  2.35294118e-01,  2.94117647e-01,  3.52941176e-01,  4.11764706e-01,  4.70588235e-01,
     5.29411765e-01,  5.88235294e-01,  6.47058824e-01,  7.05882353e-01,  7.64705882e-01,  8.23529412e-01,  8.82352941e-01,  9.41176471e-01,
     1.00000000e+00,  9.47368421e-01,  8.94736842e-01,  8.42105263e-01,  7.89473684e-01,  7.36842105e-01,  6.84210526e-01,  6.31578947e-01,
     5.78947368e-01,  5.26315789e-01,  4.73684211e-01,  4.21052632e-01,  3.68421053e-01,  3.15789474e-01,  2.63157895e-01,  2.10526316e-01,
     1.57894737e-01,  1.05263158e-01,  5.26315789e-02,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00},
   { 5.26315789e-02,  1.05263158e-01,  1.57894737e-01,  2.10526316e-01,  2.63157895e-01,  3.15789474e-01,  3.68421053e-01,  4.21052632e-01,
     4.73684211e-01,  5.26315789e-01,  5.78947368e-01,  6.31578947e-01,  6.84210526e-01,  7.36842105e-01,  7.89473684e-01,  8.42105263e-01,
     8.94736842e-01,  9.47368421e-01,  1.00000000e+00,  9.52380952e-01,  9.04761905e-01,  8.57142857e-01,  8.09523810e-01,  7.61904762e-01,
     7.14285714e-01,  6.66666667e-01,  6.19047619e-01,  5.71428571e-01,  5.23809524e-01,  4.76190476e-01,  4.28571429e-01,  3.80952381e-01,
     3.33333333e-01,  2.85714286e-01,  2.38095238e-01,  1.90476190e-01,  1.42857143e-01,  9.52380952e-02,  4.76190476e-02,  0.00000000e+00},
};

static const float FFT_WINDOW[FRAME_LEN] = {
    8.000000e-02, 8.005703e-02, 8.022812e-02, 8.051322e-02, 8.091226e-02, 8.142514e-02, 8.205173e-02, 8.279189e-02,
    8.364542e-02, 8.461211e-02, 8.569173e-02, 8.688400e-02, 8.818864e-02, 8.960531e-02, 9.113366e-02, 9.277333e-02,
    9.452389e-02, 9.638492e-02, 9.835596e-02, 1.004365e-01, 1.026261e-01, 1.049241e-01, 1.073300e-01, 1.098432e-01,
    1.124630e-01, 1.151889e-01, 1.180201e-01, 1.209559e-01, 1.239957e-01, 1.271386e-01, 1.303839e-01, 1.337308e-01,
    1.371784e-01, 1.407259e-01, 1.443724e-01, 1.481171e-01, 1.519589e-01, 1.558969e-01, 1.599302e-01, 1.640577e-01,
    1.682784e-01, 1.725913e-01, 1.769954e-01, 1.814894e-01, 1.860723e-01, 1.907431e-01, 1.955004e-01, 2.003431e-01,
    2.052701e-01, 2.102800e-01, 2.153718e-01, 2.205440e-01, 2.257955e-01, 2.311248e-01, 2.365308e-01, 2.420120e-01,
    2.475671e-01, 2.531947e-01, 2.588934e-01, 2.646619e-01, 2.704986e-01, 2.764021e-01, 2.823710e-01, 2.884038e-01,
    2.944990e-01, 3.006551e-01, 3.068705e-01, 3.131437e-01, 3.194732e-01, 3.258574e-01, 3.322947e-01, 3.387834e-01,
    3.453221e-01, 3.519090e-01, 3.585426e-01, 3.652212e-01, 3.719431e-01, 3.787067e-01, 3.855103e-01, 3.923522e-01,
    3.992307e-01, 4.061442e-01, 4.130908e-01, 4.200689e-01, 4.270767e-01, 4.341125e-01, 4.411746e-01, 4.482612e-01,
    4.553705e-01, 4.625008e-01, 4.696504e-01, 4.768174e-01, 4.840000e-01, 4.911966e-01, 4.984052e-01, 5.056242e-01,
    5.128516e-01, 5.200859e-01, 5.273250e-01, 5.345673e-01, 5.418109e-01, 5.490541e-01, 5.562951e-01, 5.635320e-01,
    5.707631e-01, 5.779865e-01, 5.852005e-01, 5.924033e-01, 5.995932e-01, 6.067682e-01, 6.139267e-01, 6.210668e-01,
    6.281869e-01, 6.352851e-01, 6.423596e-01, 6.494088e-01, 6.564308e-01, 6.634240e-01, 6.703866e-01, 6.773168e-01,
    6.842130e-01, 6.910734e-01, 6.978964e-01, 7.046802e-01, 7.114231e-01, 7.181236e-01, 7.247799e-01, 7.313904e-01,
    7.379534e-01, 7.444673e-01, 7.509305e-01, 7.573414e-01, 7.636985e-01, 7.700000e-01, 7.762445e-01, 7.824304e-01,
    7.885563e-01, 7.946204e-01, 8.006215e-01, 8.065579e-01, 8.124282e-01, 8.182310e-01, 8.239647e-01, 8.296281e-01,
    8.352196e-01, 8.407379e-01, 8.461817e-01, 8.515495e-01, 8.568401e-01, 8.620521e-01, 8.671842e-01, 8.722352e-01,
    8.772039e-01, 8.820889e-01, 8.868890e-01, 8.916032e-01, 8.962302e-01, 9.007688e-01, 9.052180e-01, 9.095766e-01,
    9.138435e-01, 9.180178e-01, 9.220983e-01, 9.260841e-01, 9.299741e-01, 9.337674e-01, 9.374631e-01, 9.410603e-01,
    9.445579e-01, 9.479553e-01, 9.512515e-01, 9.544457e-01, 9.575371e-01, 9.605250e-01, 9.634086e-01, 9.661873e-01,
    9.688602e-01, 9.714268e-01, 9.738864e-01, 9.762385e-01, 9.784823e-01, 9.806174e-01, 9.826433e-01, 9.845594e-01,
    9.863652e-01, 9.880604e-01, 9.896445e-01, 9.911170e-01, 9.924777e-01, 9.937262e-01, 9.948622e-01, 9.958854e-01,
    9.967955e-01, 9.975924e-01, 9.982758e-01, 9.988455e-01, 9.993015e-01, 9.996436e-01, 9.998717e-01, 9.999857e-01,
    9.999857e-01, 9.998717e-01, 9.996436e-01, 9.993015e-01, 9.988455e-01, 9.982758e-01, 9.975924e-01, 9.967955e-01,
    9.958854e-01, 9.948622e-01, 9.937262e-01, 9.924777e-01, 9.911170e-01, 9.896445e-01, 9.880604e-01, 9.863652e-01,
    9.845594e-01, 9.826433e-01, 9.806174e-01, 9.784823e-01, 9.762385e-01, 9.738864e-01, 9.714268e-01, 9.688602e-01,
    9.661873e-01, 9.634086e-01, 9.605250e-01, 9.575371e-01, 9.544457e-01, 9.512515e-01, 9.479553e-01, 9.445579e-01,
    9.410603e-01, 9.374631e-01, 9.337674e-01, 9.299741e-01, 9.260841e-01, 9.220983e-01, 9.180178e-01, 9.138435e-01,
    9.095766e-01, 9.052180e-01, 9.007688e-01, 8.962302e-01, 8.916032e-01, 8.868890e-01, 8.820889e-01, 8.772039e-01,
    8.722352e-01, 8.671842e-01, 8.620521e-01, 8.568401e-01, 8.515495e-01, 8.461817e-01, 8.407379e-01, 8.352196e-01,
    8.296281e-01, 8.239647e-01, 8.182310e-01, 8.124282e-01, 8.065579e-01, 8.006215e-01, 7.946204e-01, 7.885563e-01,
    7.824304e-01, 7.762445e-01, 7.700000e-01, 7.636985e-01, 7.573414e-01, 7.509305e-01, 7.444673e-01, 7.379534e-01,
    7.313904e-01, 7.247799e-01, 7.181236e-01, 7.114231e-01, 7.046802e-01, 6.978964e-01, 6.910734e-01, 6.842130e-01,
    6.773168e-01, 6.703866e-01, 6.634240e-01, 6.564308e-01, 6.494088e-01, 6.423596e-01, 6.352851e-01, 6.281869e-01,
    6.210668e-01, 6.139267e-01, 6.067682e-01, 5.995932e-01, 5.924033e-01, 5.852005e-01, 5.779865e-01, 5.707631e-01,
    5.635320e-01, 5.562951e-01, 5.490541e-01, 5.418109e-01, 5.345673e-01, 5.273250e-01, 5.200859e-01, 5.128516e-01,
    5.056242e-01, 4.984052e-01, 4.911966e-01, 4.840000e-01, 4.768174e-01, 4.696504e-01, 4.625008e-01, 4.553705e-01,
    4.482612e-01, 4.411746e-01, 4.341125e-01, 4.270767e-01, 4.200689e-01, 4.130908e-01, 4.061442e-01, 3.992307e-01,
    3.923522e-01, 3.855103e-01, 3.787067e-01, 3.719431e-01, 3.652212e-01, 3.585426e-01, 3.519090e-01, 3.453221e-01,
    3.387834e-01, 3.322947e-01, 3.258574e-01, 3.194732e-01, 3.131437e-01, 3.068705e-01, 3.006551e-01, 2.944990e-01,
    2.884038e-01, 2.823710e-01, 2.764021e-01, 2.704986e-01, 2.646619e-01, 2.588934e-01, 2.531947e-01, 2.475671e-01,
    2.420120e-01, 2.365308e-01, 2.311248e-01, 2.257955e-01, 2.205440e-01, 2.153718e-01, 2.102800e-01, 2.052701e-01,
    2.003431e-01, 1.955004e-01, 1.907431e-01, 1.860723e-01, 1.814894e-01, 1.769954e-01, 1.725913e-01, 1.682784e-01,
    1.640577e-01, 1.599302e-01, 1.558969e-01, 1.519589e-01, 1.481171e-01, 1.443724e-01, 1.407259e-01, 1.371784e-01,
    1.337308e-01, 1.303839e-01, 1.271386e-01, 1.239957e-01, 1.209559e-01, 1.180201e-01, 1.151889e-01, 1.124630e-01,
    1.098432e-01, 1.073300e-01, 1.049241e-01, 1.026261e-01, 1.004365e-01, 9.835596e-02, 9.638492e-02, 9.452389e-02,
    9.277333e-02, 9.113366e-02, 8.960531e-02, 8.818864e-02, 8.688400e-02, 8.569173e-02, 8.461211e-02, 8.364542e-02,
    8.279189e-02, 8.205173e-02, 8.142514e-02, 8.091226e-02, 8.051322e-02, 8.022812e-02, 8.005703e-02, 8.000000e-02
};

// clang-format on

static const char *labels_lut[NUM_LABELS + 1] = {
    "background",
    "left",
    "right",
    "up",
    "down",
    "stop",
    "unknown",
};

static arm_rfft_fast_instance_f32 ffti;

static void preemphasis(float *input, size_t len)
{
    for (size_t i = len - 1; i > 0; i--)
    {
        input[i] = input[i] - PREEMP_COEFF * input[i - 1];
    }
    input[0] = 0.0f;
}

static void powspec(const float input[FRAME_LEN], float output[NUM_FFT_BINS])
{
    float32_t tmp[NUM_FFT] = {0.0f};
    float32_t out[NUM_FFT];

    for (size_t i = 0; i < FRAME_LEN; i++)
    {
        tmp[i] = input[i];
    }

    arm_rfft_fast_f32(&ffti, tmp, out, 0);
    output[NUM_FFT_BINS - 1] = fabs(out[1]);
    out[1] = 0;
    arm_cmplx_mag_f32(out, output, NUM_FFT_BINS - 1);

    for (size_t i = 0; i < NUM_FFT_BINS; i++)
    {
        output[i] *= 1.0f / NUM_FFT;
        output[i] *= output[i];
    }
}

static void dcblock(float *input, size_t len)
{
    float output_prev = input[0];

    for (size_t i = 1; i < len; i++)
    {
        float out = input[i] - input[i - 1] + 0.95 * output_prev;
        input[i - 1] = output_prev;
        output_prev = out;
    }
    input[len - 1] = output_prev;
}

void fbank_init(void)
{
    arm_status status = arm_rfft_fast_init_f32(&ffti, NUM_FFT);
    assert(status == ARM_MATH_SUCCESS);
    (void)status;
}

static float frame[FRAME_LEN] = {0.0};
static float power[NUM_FFT_BINS];

void fbank(float *input, float (*output)[NUM_FILT], size_t size)
{
    size_t frame_num = 0;

    dcblock(input, size);
    preemphasis(input, size);

    for (size_t i = 0; i < size; i += FRAME_STEP)
    {
        assert((i + FRAME_LEN) <= size);

        const float *frame_start = &input[i];

        for (size_t j = 0; j < FRAME_LEN; j++)
        {
            frame[j] = frame_start[j] * FFT_WINDOW[j];
        }

        powspec(frame, power);

        size_t frame_idx = frame_num;

        for (size_t j = 0; j < NUM_FILT; j++)
        {
            output[frame_idx][j] = 0.0f;
            for (size_t k = 0; k < FILTERBANK_LEN; k += 4)
            {
                output[frame_idx][j] += power[k + FILTERBANK_OFF[j]] * FILTERBANK_MAT[j][k];
                output[frame_idx][j] += power[k + 1 + FILTERBANK_OFF[j]] * FILTERBANK_MAT[j][k + 1];
                output[frame_idx][j] += power[k + 2 + FILTERBANK_OFF[j]] * FILTERBANK_MAT[j][k + 2];
                output[frame_idx][j] += power[k + 3 + FILTERBANK_OFF[j]] * FILTERBANK_MAT[j][k + 3];
            }

            if (output[frame_idx][j] < F_EPS)
            {
                output[frame_idx][j] = F_EPS;
            }
            output[frame_idx][j] = logf(output[frame_idx][j] + 1.0e-10);
        }

        if((i + FRAME_LEN) == size)
        {
          assert(frame_num == 10);
          break;
        }
        frame_num++;
    }
}

char const *const fbank_label_idx_to_str(size_t label)
{
    if (label >= NUM_LABELS)
    {
        return labels_lut[NUM_LABELS];
    }
    else
    {
        return labels_lut[label];
    }
}